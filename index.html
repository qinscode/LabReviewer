<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comment Generator Tool for Cloud Computing Lab</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --text-color: #333;
            --border-radius: 8px;
        }

        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #fff;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px;
            height: 100vh;
            overflow-y: auto;
            box-sizing: border-box;
            scrollbar-width: none; /* 对 Firefox */
            -ms-overflow-style: none; /* 对 IE 和 Edge */
        }

        .container::-webkit-scrollbar {
            display: none; /* 对 Chrome, Safari 和 Opera */
        }

        .options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .option {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
            cursor: pointer; /* Add this line to change the cursor to a pointer on hover */
        }

        .option:hover {
            background-color: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .option input {
            margin-right: 10px;
            transform: scale(1.2);
        }

        textarea {
            width: 100%;
            height: 150px;
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            resize: vertical;
            box-sizing: border-box;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.25);
        }

        .buttons {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button i {
            margin-right: 8px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        button:active {
            transform: translateY(0);
        }

        #generateBtn {
            background-color: var(--primary-color);
            flex: 2;
        }

        #generateBtn:hover {
            background-color: #2980b9;
        }

        #clearBtn {
            background-color: var(--danger-color);
            flex: 1;
        }

        #clearBtn:hover {
            background-color: #c0392b;
        }

        #copyBtn {
            background-color: var(--secondary-color);
            flex: 1;
        }

        #copyBtn:hover {
            background-color: #27ae60;
        }

        #suggestionStepMark {
            text-align: center;
            margin: 20px 0;
            font-weight: bold;
            font-size: 18px;
            color: #fff;
            background-color: var(--primary-color);
            padding: 15px;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }

        .pulse {
            animation: pulse 0.7s ease-in-out;
        }

        @keyframes bounce {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.15);
            }
        }

        .bounce {
            animation: bounce 0.5s ease-in-out;
        }

        .title {
            color: var(--text-color);
            font-size: 16px;
            font-weight: bold;
            margin: 0 0 10px 0;
            letter-spacing: 0.5px;
            text-align: center;
        }

        .lab-selector {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .lab-selector label {
            font-weight: 600;
            color: var(--text-color);
        }

        .lab-selector select {
            padding: 10px 14px;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: all 0.3s ease;
            background-color: #fff;
        }

        .lab-selector select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.25);
        }

        .lab-details {
            background-color: #eef4ff;
            border-left: 4px solid var(--primary-color);
            padding: 12px 16px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
        }

        #labTitle {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }

        #labOverview {
            margin: 8px 0 0 0;
        }

        #labNote {
            margin: 8px 0 0 0;
            font-size: 14px;
            color: #2c3e50;
            font-style: italic;
        }

        @keyframes starJump {
            0% {
                transform: translateY(0) scale(0);
                opacity: 0;
            }
            50% {
                transform: translateY(-20px) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translateY(-40px) scale(1);
                opacity: 0;
            }
        }

        #suggestionStepMark {
            position: relative;
            overflow: hidden;
        }

        .star {
            position: absolute;
            font-size: 24px;
            color: yellow;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
            pointer-events: none;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="title">Comment Generator Tool for Lab Report</h1>
    <div class="lab-selector">
        <label for="labSelector">Select a lab</label>
        <select id="labSelector"></select>
    </div>
    <div class="lab-details">
        <h2 id="labTitle"></h2>
        <p id="labOverview"></p>
        <p id="labNote"></p>
    </div>
    <div class="options" id="options"></div>
    <div id="suggestionStepMark"></div>
    <textarea id="output" readonly placeholder="Generated comments will appear here..."></textarea>
    <div class="buttons">
        <button id="copyBtn"><i class="fas fa-copy"></i>Copy</button>

        <button id="clearBtn"><i class="fas fa-trash"></i>Clear</button>
        <button id="generateBtn"><i class="fas fa-comment"></i>Generate Comments</button>

    </div>
</div>

<script type="module">
    import { LAB_RUBRICS, DEFAULT_MARKS } from './rubrics.js';

    const output = document.getElementById('output');
    const optionsContainer = document.getElementById('options');
    const suggestionStepMark = document.getElementById('suggestionStepMark');
    const clearBtn = document.getElementById('clearBtn');
    const copyBtn = document.getElementById('copyBtn');
    const generateBtn = document.getElementById('generateBtn');
    const labSelector = document.getElementById('labSelector');
    const labTitle = document.getElementById('labTitle');
    const labOverview = document.getElementById('labOverview');
    const labNote = document.getElementById('labNote');

    let currentLab = LAB_RUBRICS[0];
    let sufficientInput = null;
    const issueInputs = new Map();

    populateSelector();
    bindEvents();
    loadLab(currentLab.id);

    function populateSelector() {
        LAB_RUBRICS.forEach((lab, index) => {
            const option = document.createElement('option');
            option.value = lab.id;
            option.textContent = lab.label;
            if (index === 0) {
                option.selected = true;
            }
            labSelector.appendChild(option);
        });
    }

    function bindEvents() {
        labSelector.addEventListener('change', event => {
            loadLab(event.target.value);
        });

        optionsContainer.addEventListener('change', handleOptionChange);
        clearBtn.addEventListener('click', () => {
            clearComments();
        });
        copyBtn.addEventListener('click', copyToClipboard);
        generateBtn.addEventListener('click', () => {
            generateComments();
            updateSuggestionStepMark();
        });
    }

    function loadLab(labId) {
        const selectedLab = LAB_RUBRICS.find(lab => lab.id === labId);
        if (!selectedLab) {
            return;
        }
        currentLab = selectedLab;
        renderLabDetails();
        buildOptions();
        clearComments();
    }

    function renderLabDetails() {
        labTitle.textContent = currentLab.label;
        labOverview.textContent = currentLab.overview || '';
        if (currentLab.ratingNote) {
            labNote.textContent = currentLab.ratingNote;
            labNote.style.display = 'block';
        } else {
            labNote.textContent = '';
            labNote.style.display = 'none';
        }
    }

    function buildOptions() {
        optionsContainer.innerHTML = '';
        issueInputs.clear();

        const sufficientOption = createOption(`${currentLab.sufficientLabel}`, `${currentLab.id}-sufficient`);
        sufficientInput = sufficientOption.querySelector('input');
        sufficientInput.checked = true;
        sufficientInput.dataset.role = 'sufficient';
        optionsContainer.appendChild(sufficientOption);

        currentLab.issues.forEach(issue => {
            const option = createOption(issue.text, issue.id);
            const input = option.querySelector('input');
            input.dataset.feedback = issue.text;
            issueInputs.set(issue.id, input);
            optionsContainer.appendChild(option);
        });
    }

    function createOption(labelText, id) {
        const label = document.createElement('label');
        label.className = 'option';
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.id = id;
        input.value = labelText;
        label.appendChild(input);
        const span = document.createElement('span');
        span.textContent = labelText;
        label.appendChild(span);
        return label;
    }

    function handleOptionChange(event) {
        const target = event.target;
        if (!target || target.tagName !== 'INPUT') {
            return;
        }

        if (target === sufficientInput) {
            issueInputs.forEach(input => {
                input.checked = false;
            });
        } else if (issueInputs.has(target.id)) {
            sufficientInput.checked = false;
        }

        if (target.type === 'checkbox') {
            const parentLabel = target.closest('.option');
            if (parentLabel) {
                parentLabel.classList.add('bounce');
                setTimeout(() => parentLabel.classList.remove('bounce'), 500);
            }
        }

        generateComments();
        updateSuggestionStepMark();
    }

    function getCheckedIssues() {
        return Array.from(issueInputs.values()).filter(input => input.checked);
    }

    function getLabShortName() {
        if (!currentLab || !currentLab.label) {
            return 'Lab';
        }
        const separatorIndex = currentLab.label.indexOf('–');
        if (separatorIndex === -1) {
            return currentLab.label.trim();
        }
        return currentLab.label.slice(0, separatorIndex).trim();
    }

    function getRating(issueCount) {
        const thresholds = currentLab.thresholds || {};
        const goodLimit = typeof thresholds.goodMaxIssues === 'number' ? thresholds.goodMaxIssues : 0;
        const mediumLimit = typeof thresholds.mediumMaxIssues === 'number'
            ? thresholds.mediumMaxIssues
            : (typeof thresholds.averageMaxIssues === 'number' ? thresholds.averageMaxIssues : goodLimit);
        const badLimit = typeof thresholds.badMaxIssues === 'number' ? thresholds.badMaxIssues : Number.POSITIVE_INFINITY;

        if (issueCount === 0 && sufficientInput && sufficientInput.checked) {
            return 'excellent';
        }

        if (issueCount > 0 && issueCount <= goodLimit) {
            return 'good';
        }

        if (issueCount > goodLimit && issueCount <= mediumLimit) {
            return 'medium';
        }

        if (issueCount > mediumLimit && issueCount <= badLimit) {
            return 'bad';
        }

        return issueCount === 0 ? 'excellent' : 'bad';
    }

    function getMarkForRating(rating) {
        const marks = currentLab.marks || DEFAULT_MARKS;
        switch (rating) {
            case 'excellent':
                return marks.excellent;
            case 'good':
                return marks.good;
            case 'medium':
                return marks.medium;
            case 'bad':
                return marks.bad;
            default:
                return marks.none || marks.bad || marks.medium;
        }
    }

    function formatDetails(details) {
        if (!details.length) {
            return '';
        }
        return details.join(' ');
    }

    function capitalize(text) {
        return text.charAt(0).toUpperCase() + text.slice(1);
    }

    function generateComments() {
        if (!sufficientInput) {
            return '';
        }

        const selectedIssues = getCheckedIssues();
        const issueCount = selectedIssues.length;
        const rating = getRating(issueCount);
        const labName = getLabShortName();
        let comment = '';

        if (rating === 'excellent') {
            comment = `${labName} descriptions are excellent because it is sufficient, and the steps are clear and well-detailed.`;
        } else {
            const details = selectedIssues.map(input => input.dataset.feedback || input.value);
            const detailText = formatDetails(details);
            const ratingText = rating === 'good' ? `${labName} descriptions are good overall, but consider: ${detailText}`
                : rating === 'medium' ? `${labName} descriptions are medium because: ${detailText}`
                : `${labName} descriptions are bad because: ${detailText}`;
            comment = detailText ? ratingText : `${labName} descriptions are ${rating}.`;
        }

        output.value = comment;
        output.classList.add('pulse');
        setTimeout(() => output.classList.remove('pulse'), 700);
        return comment;
    }

    function computeMark(issueCount) {
        const rating = getRating(issueCount);
        return getMarkForRating(rating);
    }

    function updateSuggestionStepMark() {
        if (!suggestionStepMark) {
            return;
        }

        const issueCount = getCheckedIssues().length;
        const rating = getRating(issueCount);
        const mark = getMarkForRating(rating);
        suggestionStepMark.textContent = `Step Mark Suggestion: ${mark} (${capitalize(rating)})`;

        for (let i = 0; i < 5; i++) {
            const star = document.createElement('span');
            star.textContent = '🌟';
            star.className = 'star';
            star.style.left = `${Math.random() * 100}%`;
            star.style.animationDelay = `${Math.random() * 0.5}s`;
            star.style.animation = `starJump 1s ease-out`;
            suggestionStepMark.appendChild(star);

            setTimeout(() => {
                star.remove();
            }, 1000);
        }
    }

    function clearComments() {
        if (sufficientInput) {
            sufficientInput.checked = true;
        }
        issueInputs.forEach(input => {
            input.checked = false;
        });
        output.value = '';
        if (suggestionStepMark) {
            suggestionStepMark.textContent = '';
        }
    }

    async function copyToClipboard() {
        try {
            const text = output.value;
            if (!text) {
                return;
            }

            if (window.copyToClipboard) {
                await window.copyToClipboard(text);
            } else {
                await navigator.clipboard.writeText(text);
            }

            copyBtn.textContent = 'Copied!';
            copyBtn.style.backgroundColor = '#27ae60';
            setTimeout(() => {
                copyBtn.innerHTML = '<i class="fas fa-copy"></i>Copy';
                copyBtn.style.backgroundColor = '';
            }, 2000);

            setTimeout(() => {
                clearComments();
            }, 15000);
        } catch (err) {
            console.error('Failed to copy: ', err);
        }
    }
</script>
<script type="module" src="./app.js"></script>
</body>
</html>
